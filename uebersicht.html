<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Essensbestellung Spielersitzung - Übersicht</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #d8e1fa;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #007bff;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            background-color: white;
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .reset-button {
            background-color: #dc3545;
            margin-top: 20px;
        }
        #printButton {
            background-color: #555;
        }
        .zusammenfassung-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        #gesamtuebersicht {
            width: 100%;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* NEU: CSS für die Button-Anordnung */
        .button-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }
        .button-container button {
            flex: 1;
            padding: 10px;
            white-space: nowrap;
        }
        .link-button, .home-button {
            text-decoration: none;
        }
        /* Versteckt alle unnötigen Elemente für den Druck */
        @media print {
            body > *:not(.print-only) {
                display: none !important;
            }
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>

    <img src="head.png" alt="Logo TVW" style="width:100%; max-width:600px; display:block; margin:0 auto;">

    <div class="button-container">
        <a href="index.html" class="home-button"><button>Startseite</button></a>
        <a href="order.html" class="link-button"><button>Neue Bestellung aufgeben</button></a>
    </div>

    <h1>Übersicht der Bestellungen</h1>
    
    <div class="zusammenfassung-container print-only">
        <div id="gesamtuebersicht">
            <h3>Zusammenfassung der Bestellungen</h3>
            <p>... wird geladen ...</p>
        </div>
    </div>
    <hr>
    
    <h2>Aktuelle Essensliste</h2>
    <ul id="essensliste"></ul>

    <button id="resetButton" class="reset-button">Alle Bestellungen löschen</button>
    <button id="printButton">Liste drucken</button>

    <script>
    // Dein Konfigurationscode von Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB_IoSZ3qjx7vy59MZiPNp1F5_6a9OEYYI",
      authDomain: "tvw-app-test.firebaseapp.com",
      projectId: "tvw-app-test",
      storageBucket: "tvw-app-test.firebasestorage.app",
      messagingSenderId: "114103141435",
      appId: "1:114103141435:web:824e76f9109218a1ef881e",
      measurementId: "G-G1E8WRYGG9"
    };

    // Firebase-App, Firestore und Auth initialisieren
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let userUid = null;

    // Elemente aus dem HTML-Code auswählen
    const essensliste = document.getElementById("essensliste");
    const gesamtuebersicht = document.getElementById("gesamtuebersicht");
    const resetButton = document.getElementById("resetButton");
    const printButton = document.getElementById("printButton");

    // Daten aus der Datenbank lesen, zählen und anzeigen
    function loadBestellungen() {
        db.collection("bestellungen").orderBy("timestamp", "asc").get().then((querySnapshot) => {
            essensliste.innerHTML = '';
            
            const zusammenfassungDaten = {};

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                const gerichtOriginal = data.gericht;
                const gerichtFuerZaehlung = gerichtOriginal.toLowerCase().trim();
                const sonderwuensche = data.sonderwuensche || 'Keine';
                
                if (!zusammenfassungDaten[gerichtFuerZaehlung]) {
                    zusammenfassungDaten[gerichtFuerZaehlung] = {
                        name: gerichtOriginal,
                        anzahl: 0,
                        wuensche: {}
                    };
                }
                
                zusammenfassungDaten[gerichtFuerZaehlung].anzahl++;

                if (sonderwuensche !== 'Keine') {
                    const wunschFuerZaehlung = sonderwuensche.toLowerCase().trim();
                    if (!zusammenfassungDaten[gerichtFuerZaehlung].wuensche[wunschFuerZaehlung]) {
                         zusammenfassungDaten[gerichtFuerZaehlung].wuensche[wunschFuerZaehlung] = {
                            name: sonderwuensche,
                            anzahl: 0
                         };
                    }
                    zusammenfassungDaten[gerichtFuerZaehlung].wuensche[wunschFuerZaehlung].anzahl++;
                }

                const li = document.createElement("li");
                
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Löschen";
                deleteButton.style.backgroundColor = "#dc3545";
                deleteButton.style.width = "auto";
                deleteButton.style.marginBottom = "0";
                deleteButton.className = "deleteButton";

                if (data.userId && data.userId === userUid) {
                    deleteButton.style.display = "inline-block";
                    deleteButton.addEventListener("click", () => {
                        db.collection("bestellungen").doc(doc.id).delete()
                            .then(() => {
                                console.log("Dokument erfolgreich gelöscht!");
                                loadBestellungen();
                            })
                            .catch((error) => {
                                console.error("Fehler beim Löschen des Dokuments: ", error);
                            });
                    });
                } else {
                    deleteButton.style.display = "none";
                }
                
                const divContainer = document.createElement("div");
                divContainer.style.display = "flex";
                divContainer.style.justifyContent = "space-between";
                divContainer.style.alignItems = "center";
                
                const textSpan = document.createElement("span");
                textSpan.innerHTML = `${data.name} bestellt: ${data.gericht}. Sonderwünsche: <b>${sonderwuensche}</b>`;
                
                divContainer.appendChild(textSpan);
                divContainer.appendChild(deleteButton);
                li.appendChild(divContainer);
                essensliste.appendChild(li);
            });
            
            let uebersichtHTML = '<ul>';
            for (const gerichtKey in zusammenfassungDaten) {
                const gerichtData = zusammenfassungDaten[gerichtKey];
                uebersichtHTML += `<li><strong>${gerichtData.anzahl}x ${gerichtData.name}</strong>`;
                if (Object.keys(gerichtData.wuensche).length > 0) {
                    uebersichtHTML += `<ul>`;
                    for (const wunschKey in gerichtData.wuensche) {
                        const wunschData = gerichtData.wuensche[wunschKey];
                        uebersichtHTML += `<li>${wunschData.anzahl}x Sonderwunsch: ${wunschData.name}</li>`;
                    }
                    uebersichtHTML += `</ul>`;
                }
                uebersichtHTML += `</li>`;
            }
            uebersichtHTML += '</ul>';
            
            gesamtuebersicht.innerHTML = `<h3>Zusammenfassung der Bestellungen</h3>${uebersichtHTML}`;
        });
    }

    function resetBestellungen() {
        const bestaetigung = confirm("Bist du sicher, dass du ALLE Bestellungen löschen möchtest? Dieser Vorgang kann nicht rückgängig gemacht werden.");
        
        if (bestaetigung) {
            db.collection("bestellungen").get().then((querySnapshot) => {
                const batch = db.batch();
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                return batch.commit();
            })
            .then(() => {
                alert("Alle Bestellungen wurden erfolgreich gelöscht.");
                loadBestellungen();
            })
            .catch((error) => {
                console.error("Fehler beim Löschen aller Bestellungen: ", error);
                alert("Fehler beim Löschen der Bestellungen.");
            });
        }
    }
    
    function printList() {
        window.print();
    }

    resetButton.addEventListener("click", resetBestellungen);
    printButton.addEventListener("click", printList);

    auth.signInAnonymously().then((userCredential) => {
        userUid = userCredential.user.uid;
        console.log("Benutzer-ID:", userUid);
        loadBestellungen();
    }).catch((error) => {
        console.error("Fehler bei der anonymen Anmeldung:", error);
    });
    </script>
</body>
</html>