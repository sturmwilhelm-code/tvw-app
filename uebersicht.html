<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essensbestellung Spielersitzung - Übersicht</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <style>
    :root {
        --primary-color: #1A237E;
        --background-color: #F8F9FA;
        --container-bg-color: rgba(255, 255, 255, 0.9);
        --text-color: #333;
        --button-color: #1A237E;
        --button-hover-color: #283593;
        --delete-button-color: #dc3545;
        --delete-button-hover-color: #c82333;
    }
    body {
        font-family: sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
        line-height: 1.6;
        background-image: url('background.png');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
    }
    .logo {
        width: 100%;
        max-width: 400px;
        display: block;
        margin: 0 auto 20px;
    }
    .button-container {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 20px;
    }
    .app-button {
        display: block;
        width: 100%;
        padding: 15px;
        background-color: var(--button-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        transition: background-color 0.3s ease, transform 0.1s ease;
    }
    .app-button:hover {
        background-color: var(--button-hover-color);
        transform: translateY(-2px);
    }
    .app-button:active {
        transform: translateY(0);
    }
    .container {
        background-color: var(--container-bg-color);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
    }
    h1, h2, h3 {
        color: var(--primary-color);
        text-align: center;
    }
    .page-title {
        color: white;
    }
    .order-list {
        list-style-type: none;
        padding: 0;
    }
    .order-item {
        background-color: #f0f4ff;
        border: 1px solid #d8e1fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .order-item-content {
        flex: 1;
    }
    .delete-button {
        background-color: var(--delete-button-color);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 14px;
    }
    .delete-button:hover {
        background-color: var(--delete-button-hover-color);
    }
    .summary-section {
        margin-top: 30px;
        border-top: 2px solid var(--primary-color);
        padding-top: 20px;
    }
    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        display: none; /* Initial state: hidden */
    }
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
    }
    .modal-content p {
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
    }
    .modal-buttons {
        display: flex;
        justify-content: space-around;
        gap: 10px;
    }
    .modal-button {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        transition: background-color 0.3s;
    }
    .modal-confirm {
        background-color: var(--delete-button-color);
        color: white;
    }
    .modal-confirm:hover {
        background-color: var(--delete-button-hover-color);
    }
    .modal-cancel {
        background-color: #ccc;
        color: var(--text-color);
    }
    .modal-cancel:hover {
        background-color: #aaa;
    }
    .imprint-text {
        text-align: center;
        font-size: 12px;
        margin-top: 40px;
        color: #666;
    }
    .imprint-text a {
        color: #666;
        text-decoration: none;
        transition: color 0.3s ease;
    }
    .imprint-text a:hover {
        color: #999;
        text-decoration: underline;
    }
    @media print {
        body {
            background-image: none;
            max-width: none;
        }
        .container {
            box-shadow: none;
            background-color: transparent;
            border: none;
        }
        .button-container, .order-item .delete-button, .imprint-text {
            display: none;
        }
    }
    </style>
</head>
<body>

    <img src="head.png" alt="Logo TVW" class="logo">

    <div class="button-container">
        <a href="order.html" class="app-button">Zurück zur Bestellung</a>
        <button id="printButton" class="app-button">Zusammenfassung drucken</button>
    </div>

    <h1 class="page-title">Essensbestellungen - Übersicht</h1>

    <div class="container">
        <h2>Einzelbestellungen</h2>
        <ul id="essensliste" class="order-list">
            <li><p>Bestellungen werden geladen...</p></li>
        </ul>

        <div id="gesamtuebersicht" class="summary-section">
            <p>Zusammenfassung wird geladen...</p>
        </div>
    </div>
    
    <div class="imprint-text">
        <p>
            <a href="impressum.html">Impressum</a> | <a href="datenschutz.html">Datenschutz</a>
        </p>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <p>Bist du sicher, dass du diese Bestellung löschen möchtest?</p>
            <div class="modal-buttons">
                <button id="confirmDelete" class="modal-button modal-confirm">Ja</button>
                <button id="cancelDelete" class="modal-button modal-cancel">Abbrechen</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyB_IoSZ3qjx7vy59MZiPNp1F5_6a9OEYYI",
            authDomain: "tvw-app-test.firebaseapp.com",
            projectId: "tvw-app-test",
            storageBucket: "tvw-app-test.firebasestorage.app",
            messagingSenderId: "114103141435",
            appId: "1:114103141435:web:824e76f9109218a1ef881e",
            measurementId: "G-G1E8WRYGG9"
        };
        
        // Initialisiere Firebase und Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI-Elemente
        const essenslisteElement = document.getElementById('essensliste');
        const gesamtuebersichtElement = document.getElementById('gesamtuebersicht');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteButton = document.getElementById('confirmDelete');
        const cancelDeleteButton = document.getElementById('cancelDelete');
        const printButton = document.getElementById('printButton');

        let pendingDeletion = null; // Speichert die ID des zu löschenden Dokuments
        let currentSummaryData = {}; // Speichert die aktuellen Zusammenfassungsdaten

        /**
         * Zeigt das benutzerdefinierte Modal zur Bestätigung an.
         * @returns {Promise<boolean>} Ein Promise, das zu `true` auflöst, wenn bestätigt, sonst zu `false`.
         */
        function showConfirmModal() {
            return new Promise(resolve => {
                deleteModal.style.display = 'flex';
                confirmDeleteButton.onclick = () => {
                    deleteModal.style.display = 'none';
                    resolve(true);
                };
                cancelDeleteButton.onclick = () => {
                    deleteModal.style.display = 'none';
                    resolve(false);
                };
            });
        }
        
        /**
         * Generiert eine HTML-Tabelle für den Druck
         * @param {object} data Die Zusammenfassungsdaten
         * @returns {string} Die fertige HTML-Tabelle
         */
        function createPrintTable(data) {
            let html = `
                <style>
                    body { font-family: sans-serif; }
                    h2 { color: #1A237E; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; color: #1A237E; }
                    .note { font-style: italic; color: #555; }
                </style>
                <h2>Zusammenfassung der Essensbestellungen</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Gericht</th>
                            <th>Anzahl</th>
                            <th>Sonderwünsche</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const gericht in data) {
                const item = data[gericht];
                let wuensche = Object.keys(item.wuensche).length > 0
                    ? Object.entries(item.wuensche).map(([wunsch, anzahl]) => `${anzahl}x ${wunsch}`).join(', ')
                    : 'Keine';
                
                html += `
                    <tr>
                        <td>${gericht}</td>
                        <td>${item.anzahl}</td>
                        <td>${wuensche}</td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }

        // Event-Listener für den Druck-Button
        printButton.addEventListener('click', () => {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Bestellungen drucken</title></head><body>');
            printWindow.document.write(createPrintTable(currentSummaryData));
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        });

        // Anonyme Anmeldung, damit die Daten gelesen werden können
        signInAnonymously(auth).then(() => {
            // Echtzeit-Listener für die Bestellungen in der Firestore-Datenbank
            onSnapshot(collection(db, "bestellungen"), async (snapshot) => {
                const bestellungenDaten = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Einzelbestellungen anzeigen
                essenslisteElement.innerHTML = '';
                let gesamtBestellungen = 0;
                const zusammenfassungDaten = {};

                bestellungenDaten.forEach(bestellung => {
                    const li = document.createElement('li');
                    li.className = 'order-item';
                    
                    const content = document.createElement('div');
                    content.className = 'order-item-content';
                    content.innerHTML = `
                        <p><strong>Name:</strong> ${bestellung.name || 'Anonym'}</p>
                        <p><strong>Gericht:</strong> ${bestellung.gericht}</p>
                        ${bestellung.sonderwuensche ? `<p><strong>Sonderwunsch:</strong> ${bestellung.sonderwuensche}</p>` : ''}
                    `;
                    li.appendChild(content);

                    // Lösch-Button hinzufügen
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Löschen';
                    deleteButton.className = 'delete-button';
                    
                    // Event-Listener für den Lösch-Button
                    deleteButton.addEventListener('click', async () => {
                        const confirmed = await showConfirmModal();
                        if (confirmed) {
                            try {
                                // Nur löschen, wenn der Benutzer ein Admin ist (nicht anonym)
                                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                                    await deleteDoc(doc(db, "bestellungen", bestellung.id));
                                    console.log("Bestellung erfolgreich gelöscht.");
                                } else {
                                    console.error("Löschen ist nur für Administratoren erlaubt.");
                                    // Optional: Meldung an den Benutzer senden, dass er keine Berechtigung hat.
                                }
                            } catch (error) {
                                console.error("Fehler beim Löschen der Bestellung: ", error);
                            }
                        }
                    });
                    
                    li.appendChild(deleteButton);
                    essenslisteElement.appendChild(li);

                    // Daten für die Zusammenfassung aufbereiten
                    gesamtBestellungen++;
                    if (zusammenfassungDaten[bestellung.gericht]) {
                        zusammenfassungDaten[bestellung.gericht].anzahl++;
                        // Hier wurde wunsch zu sonderwunsch geändert
                        if (bestellung.sonderwuensche) {
                            zusammenfassungDaten[bestellung.gericht].wuensche[bestellung.sonderwuensche] = (zusammenfassungDaten[bestellung.gericht].wuensche[bestellung.sonderwuensche] || 0) + 1;
                        }
                    } else {
                        zusammenfassungDaten[bestellung.gericht] = {
                            anzahl: 1,
                            // Hier wurde wunsch zu sonderwunsch geändert
                            wuensche: bestellung.sonderwuensche ? { [bestellung.sonderwuensche]: 1 } : {}
                        };
                    }
                });
                
                // Zusammenfassungsdaten speichern, um sie für den Druck zu verwenden
                currentSummaryData = zusammenfassungDaten;

                // Zusammenfassung anzeigen
                let uebersichtHTML = `<h4>Gesamt: ${gesamtBestellungen} Bestellungen</h4><ul class="order-list">`;
                for (const gericht in zusammenfassungDaten) {
                    const data = zusammenfassungDaten[gericht];
                    uebersichtHTML += `<li><strong>${data.anzahl}x ${gericht}</strong>`;
                    if (Object.keys(data.wuensche).length > 0) {
                        uebersichtHTML += `<ul style="list-style-type: disc; padding-left: 20px;">`;
                        for (const wunsch in data.wuensche) {
                            uebersichtHTML += `<li>${data.wuensche[wunsch]}x Sonderwunsch: ${wunsch}</li>`;
                        }
                        uebersichtHTML += `</ul>`;
                    }
                    uebersichtHTML += `</li>`;
                }
                uebersichtHTML += '</ul>';
                
                gesamtuebersichtElement.innerHTML = `<h3>Zusammenfassung der Bestellungen</h3>${uebersichtHTML}`;
            });
        }).catch((error) => {
            console.error("Fehler bei der anonymen Anmeldung:", error);
        });
    </script>
</body>
</html>